@using StudentCharityHub.Models
@using System.Security.Claims
@{
    ViewData["Title"] = "Messages";
    var sent = ViewBag.SentMessages as List<Message> ?? new();
    var received = ViewBag.ReceivedMessages as List<Message> ?? new();
    var userId = User.FindFirstValue(ClaimTypes.NameIdentifier);
    
    // Group messages by conversation (sender-receiver pair)
    var allMessages = sent.Concat(received).OrderByDescending(m => m.CreatedAt).ToList();
    var conversations = new Dictionary<string, List<Message>>();
    
    foreach (var msg in allMessages)
    {
        // Create a unique key for each conversation pair
        var otherUserId = msg.SenderId == userId ? msg.ReceiverId : msg.SenderId;
        var conversationKey = string.Compare(userId, otherUserId) < 0 
            ? $"{userId}_{otherUserId}" 
            : $"{otherUserId}_{userId}";
        
        if (!conversations.ContainsKey(conversationKey))
        {
            conversations[conversationKey] = new List<Message>();
        }
        conversations[conversationKey].Add(msg);
    }
    
    // Sort conversations by most recent message
    var sortedConversations = conversations.OrderByDescending(c => c.Value.Max(m => m.CreatedAt)).ToList();
}

<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h2 mb-0 fw-bold">
            <i class="bi bi-envelope-heart-fill me-2 text-primary"></i>Messages
        </h1>
        <a asp-controller="Home" asp-action="Dashboard" class="btn btn-outline-secondary">
            <i class="bi bi-house me-2"></i>Back to Dashboard
        </a>
    </div>

    @if (sortedConversations.Any())
    {
        <div class="row">
            <div class="col-12">
                @foreach (var conversation in sortedConversations)
                {
                    var messages = conversation.Value.OrderBy(m => m.CreatedAt).ToList();
                    var firstMessage = messages.First();
                    var otherUser = firstMessage.SenderId == userId 
                        ? firstMessage.Receiver 
                        : firstMessage.Sender;
                    var otherUserId = firstMessage.SenderId == userId ? firstMessage.ReceiverId : firstMessage.SenderId;
                    var otherUserName = otherUser?.Email ?? otherUser?.FirstName + " " + otherUser?.LastName ?? otherUserId;
                    var latestMessage = messages.Last();
                    var unreadCount = messages.Count(m => m.ReceiverId == userId && !m.IsRead);
                    
                    <div class="card mb-3 shadow-sm border-0">
                        <div class="card-header bg-light">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h5 class="mb-0">
                                        <i class="bi bi-person-circle me-2"></i>
                                        @otherUserName
                                        @if (unreadCount > 0)
                                        {
                                            <span class="badge bg-primary ms-2">@unreadCount New</span>
                                        }
                                    </h5>
                                    @if (firstMessage.Student != null)
                                    {
                                        <small class="text-muted">
                                            <i class="bi bi-mortarboard me-1"></i>About: @firstMessage.Student.FullName
                                        </small>
                                    }
                                </div>
                                <a asp-action="Reply" asp-route-messageId="@latestMessage.Id" class="btn btn-sm btn-primary">
                                    <i class="bi bi-reply me-1"></i>Reply
                                </a>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="conversation-thread">
                                @foreach (var msg in messages)
                                {
                                    var isOwnMessage = msg.SenderId == userId;
                                    <div class="message-bubble mb-3 @(isOwnMessage ? "ms-auto" : "")" style="max-width: 75%;">
                                        <div class="card @(isOwnMessage ? "bg-primary text-white" : "bg-light")">
                                            <div class="card-body p-3">
                                                <div class="d-flex justify-content-between align-items-start mb-2">
                                                    <div>
                                                        <strong>@(isOwnMessage ? "You" : (msg.Sender?.Email ?? msg.Sender?.FirstName + " " + msg.Sender?.LastName ?? msg.SenderId))</strong>
                                                        @if (!isOwnMessage && !msg.IsRead)
                                                        {
                                                            <span class="badge bg-warning text-dark ms-2">New</span>
                                                        }
                                                    </div>
                                                    <small class="@(isOwnMessage ? "text-white-50" : "text-muted")">
                                                        @msg.CreatedAt.ToString("MMM dd, hh:mm tt")
                                                    </small>
                                                </div>
                                                <p class="mb-0" style="white-space: pre-wrap;">@msg.Content</p>
                                                @if (!string.IsNullOrEmpty(msg.ModeratorNotes))
                                                {
                                                    <div class="alert alert-warning mt-2 mb-0 p-2">
                                                        <small><i class="bi bi-shield-check me-1"></i>@msg.ModeratorNotes</small>
                                                    </div>
                                                }
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                            <div class="mt-3 pt-3 border-top">
                                <a asp-action="Reply" asp-route-messageId="@latestMessage.Id" class="btn btn-primary">
                                    <i class="bi bi-reply me-2"></i>Reply to Conversation
                                </a>
                                <a asp-action="Details" asp-route-id="@latestMessage.Id" class="btn btn-outline-secondary">
                                    <i class="bi bi-eye me-2"></i>View Details
                                </a>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    }
    else
    {
        <div class="card shadow-sm border-0">
            <div class="card-body text-center py-5">
                <i class="bi bi-inbox fs-1 text-muted mb-3 d-block"></i>
                <h4 class="text-muted">No messages yet</h4>
                <p class="text-muted">Start a conversation by messaging a student or admin.</p>
                @if (User.IsInRole("Donor"))
                {
                    <a asp-controller="Student" asp-action="Index" class="btn btn-primary">
                        <i class="bi bi-search me-2"></i>Browse Students
                    </a>
                }
                @if (User.IsInRole("Student"))
                {
                    <a asp-action="ContactAdmin" class="btn btn-primary">
                        <i class="bi bi-headset me-2"></i>Contact Admin
                    </a>
                }
            </div>
        </div>
    }
</div>

<style>
    .conversation-thread {
        max-height: 400px;
        overflow-y: auto;
        padding: 10px;
    }
    .message-bubble {
        animation: fadeIn 0.3s;
    }
    @@keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
</style>
